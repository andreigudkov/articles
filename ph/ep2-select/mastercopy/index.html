<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="author" content="Andrei Gudkov">
<title>Practical Hadoop, episode 2: SELECT</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}audio,canvas,video{display:inline-block}audio:not([controls]){display:none;height:0}[hidden],template{display:none}script{display:none !important}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}a{background:transparent}a:focus{outline:thin dotted}a:active,a:hover{outline:0}h1{font-size:2em;margin:.67em 0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}mark{background:#ff0;color:#000}code,kbd,pre,samp{font-family:monospace,serif;font-size:1em}pre{white-space:pre-wrap}q{quotes:"\201C" "\201D" "\2018" "\2019"}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:0}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}button,input{line-height:normal}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}textarea{overflow:auto;vertical-align:top}table{border-collapse:collapse;border-spacing:0}*,*::before,*::after{box-sizing:border-box;margin:0}body{font-family:Helvetica,Arial,sans-serif;font-size:16px;color:#222;line-height:1.5;max-width:55em;margin:0 auto}#content,#footnotes{padding-left:.5em;padding-right:.5em}strong{font-weight:bold}em{font-style:italic}:not(pre)>code{font-family:Courier,monospace;line-height:1.0}a{color:#0061c5;text-decoration:none}a:hover{text-decoration:underline}hr{border-width:0 0 1px 0;border-style:solid;border-color:#678}ul,ol{list-style-position:outside;padding-left:0;margin-left:2em}ul li ul,ul li ol,ol li ul,ol li ol{margin-left:1.414em}ul>li{list-style-type:square;font-size:80%}ul>li>*{font-size:125%}ol>li{font-weight:bold}ol>li>*{font-weight:normal}ol.arabic{list-style-type:decimal}ol.decimal{list-style-type:decimal-leading-zero}ol.loweralpha{list-style-type:lower-alpha}ol.upperalpha{list-style-type:upper-alpha}ol.lowerroman{list-style-type:lower-roman}ol.upperroman{list-style-type:upper-roman}ol.lowergreek{list-style-type:lower-greek}.dlist dt{color:#325d72;font-weight:bold}.dlist dt:not(:first-child){margin-top:1em}.dlist dd{margin-left:2em}td.hdlist1{color:#325d72;padding-right:.5em;vertical-align:top}td.hdlist2{padding-bottom:.5em}h1{font-size:28px;font-weight:normal;letter-spacing:-1px;color:white;background-color:#325d72;text-align:center;margin:0 0 .5em 0;padding:.05em .5em}@media print{h1{color:#325d72;background-color:white;font-weight:bold}}h1::after{content:':';width:0;overflow:hidden;display:inline-block;vertical-align:middle}.author{color:#325d72}.email::before{content:"<";color:#325d72}.email::after{content:">";color:#325d72}.author+br,.email+br{display:none}#author{padding-left:.5em}#toc{margin:1em 0 2em 0;padding-left:.5em}#toctitle{font-size:19px;font-weight:bold;color:#325d72;margin:.5em 0}#toc>ul{line-height:1.4;font-size:15px;margin:0 0 0 .5em}#toc ul li{list-style-type:none}#toc li{margin:0}.big{font-size:120%}.small{font-size:75%}.underline{text-decoration:underline}.overline{text-decoration:overline}.line-through{text-decoration:line-through}.aqua{color:#00bfbf}.aqua-background{background-color:#00fafa;border-radius:2px;padding:0 3px}.black{color:"black"}.black-background{background-color:"black";border-radius:2px;padding:0 3px}.blue{color:#0000bf}.blue-background{background-color:#0000fa;border-radius:2px;padding:0 3px}.fuchsia{color:#bf00bf}.fuchsia-background{background-color:#fa00fa;border-radius:2px;padding:0 3px}.gray{color:#606060}.gray-background{background-color:#7d7d7d;border-radius:2px;padding:0 3px}.green{color:#006000}.green-background{background-color:#007d00;border-radius:2px;padding:0 3px}.lime{color:#00bf00}.lime-background{background-color:#00fa00;border-radius:2px;padding:0 3px}.maroon{color:#600000}.maroon-background{background-color:#7d0000;border-radius:2px;padding:0 3px}.navy{color:#000060}.navy-background{background-color:#00007d;border-radius:2px;padding:0 3px}.olive{color:#606000}.olive-background{background-color:#7d7d00;border-radius:2px;padding:0 3px}.purple{color:#600060}.purple-background{background-color:#7d007d;border-radius:2px;padding:0 3px}.red{color:#bf0000}.red-background{background-color:#fa0000;border-radius:2px;padding:0 3px}.silver{color:#909090}.silver-background{background-color:#bcbcbc;border-radius:2px;padding:0 3px}.teal{color:#006060}.teal-background{background-color:#007d7d;border-radius:2px;padding:0 3px}.white{color:#bfbfbf}.white-background{background-color:#fafafa;border-radius:2px;padding:0 3px}.yellow{color:#bfbf00}.yellow-background{background-color:#fafa00;border-radius:2px;padding:0 3px}table.tableblock{border:1px solid #91a7b3;margin-left:auto;margin-right:auto}table.tableblock>caption.title{text-align:left;margin-bottom:.5em}table.tableblock>colgroup>col{width:inherit !important}table.tableblock>tbody>tr>td{border-style:solid;border-color:#91a7b3;border-width:0 1px;padding:0 5px 2px 5px}table.tableblock>tbody>tr:nth-of-type(2n){background-color:#f3f5f7}p.tableblock{text-align:inherit}table.tableblock>thead>tr>td,table.tableblock>thead>tr>th,table.tableblock>tfoot>tr>td,table.tableblock>tfoot>tr>th{color:#325d72;font-weight:bold;line-height:1.35;padding:2px 5px;border:1px solid #91a7b3}table.tableblock>thead>tr>th,table.tableblock>thead>tr>td{border-bottom-width:2px}table.tableblock>tfoot>tr>th,table.tableblock>tfoot>tr>td{border-top-width:2px}th.halign-left,td.halign-left{text-align:left}th.halign-right,td.halign-right{text-align:right}th.halign-center,td.halign-center{text-align:center}th.valign-top,td.valign-top{vertical-align:top}th.valign-bottom,td.valign-bottom{vertical-align:bottom}th.valign-middle,td.valign-middle{vertical-align:middle}div.listingblock{padding:.5em;border-style:solid;border-color:#678;border-width:0 0 0 2px;background-color:#f3f5f7;overflow:auto}div.listingblock .title{text-align:right}div.listingblock pre{font-family:Menlo,Consolas,Monaco,"Lucida Console",monospace;font-size:87.5%;white-space:pre;background-color:#f3f5f7 !important;margin:0}div.listingblock td.linenos{border-right:1px solid #91a7b3;padding-right:.67em}div.listingblock table.pyhltable div.linenodiv{color:#678;text-align:right}div.listingblock table.pyhltable td.code{padding-left:.67em}div.imageblock>div.content>img{max-width:98%}.text-indent{padding-left:2em}img.inlinemath{image-rendering:optimizequality;margin-top:.5ex}h2,h3,h4{font-weight:normal;color:#325d72;margin:0}h2{font-size:27px;letter-spacing:-1px;border-bottom:1px solid #91a7b3}h3{font-size:24px;letter-spacing:-0.75px}h4{font-size:21px;letter-spacing:-0.5px}.title{color:#325d72;font-weight:bold}#footer{font-size:80%;color:white;background-color:#325d72}@media print{#footer{color:#325d72;background-color:white;font-weight:bold}}#footer-text{text-align:center;padding:.5em}#footer-badges{display:none}span.footnote{vertical-align:super;font-size:80%}#footnotes>hr{display:none}#footnotes::before{display:block;border-bottom:1px solid #678;margin:.5em 0;content:"Notes";font-size:19px;font-weight:bold;color:#325d72}#footnotes .footnote{margin-left:.5em;font-size:15px}hr:not(:first-child){margin-top:1.5em}hr:not(:last-child){margin-bottom:1.5em}.imageblock:not(:last-child),.listingblock:not(:last-child),.tableblock:not(:last-child){margin-bottom:1em}p+*{margin-top:1em}.paragraph+*{margin-top:1em}p+.ulist,p+.olist,p+.dlist,p+.hdlist,.paragraph+.ulist,.paragraph+.olist,.paragraph+.dlist,.paragraph+.hdlist,.paragraph+.listingblock{margin-top:.5em !important}li *+.ulist,li *+.olist,li *+.dlist,li *+.hdlist{margin-top:.1em !important}.title:not(:first-child){margin-top:1.5em}.content+.title{margin-top:.5em !important}.title+*{margin-top:1.5em}.title+p,.title+.paragraph,.title+.ulist,.title+.olist,.title+.dlist,.title+.hdlist{margin-top:.5em !important}.ulist:not(:last-child){margin-bottom:1em}.olist:not(:last-child){margin-bottom:1em}li:not(:first-child){margin-top:.1em}.dlist:not(:last-child){margin-bottom:1em}.dlist:not(:first-child){margin-top:1em}.sect3:not(:last-child){margin-bottom:18px}.sect3:not(:first-child){margin-top:18px}h4:not(:last-child){margin-bottom:9px}.sect2:not(:last-child){margin-bottom:22px}.sect2:not(:first-child){margin-top:22px}h3:not(:last-child){margin-bottom:11px}.sect1:not(:last-child){margin-bottom:40px}.sect1:not(:first-child){margin-top:40px}#preamble:not(:last-child){margin-bottom:40px}h2:not(:last-child){margin-bottom:13px}#header:not(:last-child),#content:not(:last-child),#footnotes:not(:last-child){margin-bottom:2em}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}
</style>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments, .listingblock .pygments code { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>Practical Hadoop, episode 2: SELECT</h1>
<div class="details">
<span id="author" class="author">Andrei Gudkov</span><br>
<span id="email" class="email"><a href="mailto:gudokk@gmail.com">gudokk@gmail.com</a></span><br>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In the first article we&#8217;ve learned how to create scalable and efficient implementation of JOIN operation.
Our second problem will be focused on how to extract small subset of records from immensely large collection.
This problem occurs often in big data processing.</p>
</div>
<div class="paragraph">
<p>I am going to use the same domain model that I used in previous example.
Once again, we are building an ads engine.
We have a huge pool of sessions, where each session corresponds to a sequence of events of a single
user during brief amount of time.
Let&#8217;s further suppose that every session has <code>url</code> field that carries webpage address of where these events occurred.
We also have a text file with some number of URLs and we would like to extract all sessions from our large
pool of sessions which have one of these URLs.
Important is that we expect that number of selected sessions will be negligibly small compared to the overall amount of sessions.
For example, we could have 10 TB of sessions, 100 MB text file with URLs and we expect to get 20 GB of sessions in the result.
There are myriad possible situations leading to this problem:
maybe we want to check some statistical hypothesis over the websites of specific thematics,
maybe one of our clients requested all associated information.
or maybe we just want to recompute KPIs.
In all cases, the statement of SELECT problem is the same:
how to extract small subset of data from immensely large collection by primary or secondary key.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="select-problem.png" alt="select problem" width="55%">
</div>
</div>
<div class="paragraph">
<p>Because this is an ad hoc problem, we do not want to waste time on building index&#8201;&#8212;&#8201;we&#8217;d rather
stick with one full scan over the sessions collection.
First indexless solution that comes to my mind is to avoid using reducers and do filtering directly in mappers.
Because number of URLs is small, we can load them into each mapper in the <code>setup()</code> method
and then use them to filter incoming sessions.
Sessions that pass our check go directly from mappers to output files.
We can still use reducers in order to control the number of output files.
Indeed, using mapper-only approach would create one output file per each split of input data (100 MB by default),
resulting in tens of thousands of tiny files, which may be inconvenient.</p>
</div>
<div class="paragraph">
<p>Code below demonstrates mapper-only approach.
We create sequence file of URLs in main code (not shown) in format <code>(NullWritable, Any{url})</code> and pass its path to mappers
via <code>conf.url.path</code> configuration option.
Mappers load this file in <code>setup()</code> method.
Next, every incoming session is checked against this list.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="select-dataflow-v1.png" alt="select dataflow v1" width="55%">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</div></td><td class="code"><span></span><span class="tok-kd">private</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">urls</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;&gt;();</span> <span class="tok-c1">// list of URLs of interest</span>

<span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">setup</span><span class="tok-o">(</span><span class="tok-n">Mapper</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">,</span> <span class="tok-n">IntWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">&gt;.</span><span class="tok-na">Context</span> <span class="tok-n">context</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">Configuration</span> <span class="tok-n">conf</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getConfiguration</span><span class="tok-o">();</span>
  <span class="tok-n">Path</span> <span class="tok-n">path</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Path</span><span class="tok-o">(</span><span class="tok-n">conf</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;conf.url.path&quot;</span><span class="tok-o">));</span>
  <span class="tok-n">SequenceFile</span><span class="tok-o">.</span><span class="tok-na">Reader</span> <span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">SequenceFile</span><span class="tok-o">.</span><span class="tok-na">Reader</span><span class="tok-o">(</span><span class="tok-n">conf</span><span class="tok-o">,</span> <span class="tok-n">SequenceFile</span><span class="tok-o">.</span><span class="tok-na">Reader</span><span class="tok-o">.</span><span class="tok-na">file</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">));</span>
  <span class="tok-n">NullWritable</span> <span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-n">NullWritable</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">();</span>
  <span class="tok-n">Any</span> <span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Any</span><span class="tok-o">();</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">reader</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">(</span><span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">value</span><span class="tok-o">))</span> <span class="tok-o">{</span>
    <span class="tok-n">urls</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>
  <span class="tok-n">reader</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>

  <span class="tok-n">Collections</span><span class="tok-o">.</span><span class="tok-na">sort</span><span class="tok-o">(</span><span class="tok-n">urls</span><span class="tok-o">);</span>
<span class="tok-o">}</span>

<span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">map</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span> <span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">Any</span> <span class="tok-n">value</span><span class="tok-o">,</span>
                   <span class="tok-n">Mapper</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">,</span> <span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">&gt;.</span><span class="tok-na">Context</span> <span class="tok-n">context</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">Collections</span><span class="tok-o">.</span><span class="tok-na">binarySearch</span><span class="tok-o">(</span><span class="tok-n">urls</span><span class="tok-o">,</span> <span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">)</span> <span class="tok-o">&gt;=</span> <span class="tok-mi">0</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-n">Any</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Code above works well but only when all URLs fit into RAM.
Once URL volume exceeds memory of a single mapper, this solution cannot be used anymore.
You will have to split URL list into sublists and to run multiple jobs over the same input
data but with different sublists.
This is expensive.</p>
</div>
<div class="paragraph">
<p>To make our job independent on number of URLs, we are going to use classical MapReduce approach.
As in first version, we will first create a sequence file with URLs in format <code>(NullWritable, Any{url})</code> and put in HDFS.
Next we will create a job that tasks both URLs and sessions files as input and joins them.
URL is used as join key, so that all objects&#8201;&#8212;&#8201;both sessions and URLs&#8201;&#8212;&#8201;are delivered to the same reducer.
Reducer emits only those sessions which have URL from our list of interest.
To optimize sorting operation, <code>hash(URL)</code> is used as a key instead of URL itself.
This slightly complicates reducer because now there is a chance that multiple URLs will map into the same <code>hash(url)</code>.
As such, reducer has to track multiple URLs at once.</p>
</div>
<div class="paragraph">
<p>We also assume that number of sessions with single URL is small.
In real-world, this might not be the case, and we would have to use the approach described in previous article.
That is, to split sessions with the same URLs into multiple shards with the key <code>{hash(URL), shardId(0..20)}</code>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="select-dataflow-v2.png" alt="select dataflow v2" width="80%">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</div></td><td class="code"><span></span><span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">map</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span> <span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">Any</span> <span class="tok-n">value</span><span class="tok-o">,</span>
                   <span class="tok-n">Mapper</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">,</span> <span class="tok-n">IntWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">&gt;.</span><span class="tok-na">Context</span> <span class="tok-n">context</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">IntWritable</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()),</span> <span class="tok-k">new</span> <span class="tok-n">Any</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span><span class="tok-o">));</span>
  <span class="tok-o">}</span>
  <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span> <span class="tok-c1">// use hash(url) to increase sort performance</span>
    <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">IntWritable</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()),</span> <span class="tok-k">new</span> <span class="tok-n">Any</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">));</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">reduce</span><span class="tok-o">(</span><span class="tok-n">IntWritable</span> <span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">Any</span><span class="tok-o">&gt;</span> <span class="tok-n">values</span><span class="tok-o">,</span>
                      <span class="tok-n">Reducer</span><span class="tok-o">&lt;</span><span class="tok-n">IntWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">,</span> <span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">&gt;.</span><span class="tok-na">Context</span> <span class="tok-n">context</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">urls</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;&gt;();</span>
  <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Session</span><span class="tok-o">&gt;</span> <span class="tok-n">sessions</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;&gt;();</span>
  <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Any</span> <span class="tok-n">value</span> <span class="tok-o">:</span> <span class="tok-n">values</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">urls</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">sessions</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
  <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span> <span class="tok-o">:</span> <span class="tok-n">sessions</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">urls</span><span class="tok-o">.</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">))</span> <span class="tok-o">{</span>
      <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-n">Any</span><span class="tok-o">(</span><span class="tok-n">session</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Compared to the first version, the above code works for any number of input URLs.
But the problem is that it is extremely inefficient.
Indeed, it sorts and transfers the whole volume of sessions from mappers to reducers,
even though we need tiny fraction of it.
Situation when all reducers combined receive dozens of terabytes of sessions but emit only
couple of gigabytes to the output is typical for the above solution.</p>
</div>
<div class="paragraph">
<p>Now we have two solutions: one is efficient but is not scalable, another one is scalable but is not efficient.
In order to get benefits of both of them, we are going to combine them, replacing ordinary set of URLs in mapper
with <a href="https://en.wikipedia.org/wiki/Bloom_filter">Bloom filter</a>.
This results in that now we have two filters: one is a rough filter on mapper,
another one is a precise filter on reducer.
First filter removes almost all irrelevant data not including small amount of false positives&#8201;&#8212;&#8201;sessions with
URLs that were not added to Bloom filter but which are reported as if they were added.
Reducer provides second filtering stage and removes final bits of irrelevant data from the stream.
For example, consider typical situation when Bloom filter removes 97% of input sessions and reducer removes 2% more.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="select-dataflow-v3.png" alt="select dataflow v3" width="95%">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</div></td><td class="code"><span></span><span class="tok-kd">private</span> <span class="tok-n">BloomFilter</span> <span class="tok-n">urls</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">BloomFilter</span><span class="tok-o">(</span><span class="tok-mi">32</span><span class="tok-o">*</span><span class="tok-mi">1024</span><span class="tok-o">*</span><span class="tok-mi">1024</span><span class="tok-o">*</span><span class="tok-mi">8</span><span class="tok-o">,</span> <span class="tok-mi">50</span><span class="tok-o">);</span> <span class="tok-c1">// 32 MiB, 50 hash functions</span>

<span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">setup</span><span class="tok-o">(</span><span class="tok-n">Mapper</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">,</span> <span class="tok-n">IntWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">&gt;.</span><span class="tok-na">Context</span> <span class="tok-n">context</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">Configuration</span> <span class="tok-n">conf</span> <span class="tok-o">=</span> <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">getConfiguration</span><span class="tok-o">();</span>
  <span class="tok-n">Path</span> <span class="tok-n">path</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Path</span><span class="tok-o">(</span><span class="tok-n">conf</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-s">&quot;conf.url.path&quot;</span><span class="tok-o">));</span>
  <span class="tok-n">SequenceFile</span><span class="tok-o">.</span><span class="tok-na">Reader</span> <span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">SequenceFile</span><span class="tok-o">.</span><span class="tok-na">Reader</span><span class="tok-o">(</span><span class="tok-n">conf</span><span class="tok-o">,</span> <span class="tok-n">SequenceFile</span><span class="tok-o">.</span><span class="tok-na">Reader</span><span class="tok-o">.</span><span class="tok-na">file</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">));</span>
  <span class="tok-n">NullWritable</span> <span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-n">NullWritable</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">();</span>
  <span class="tok-n">Any</span> <span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Any</span><span class="tok-o">();</span>
  <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">reader</span><span class="tok-o">.</span><span class="tok-na">next</span><span class="tok-o">(</span><span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">value</span><span class="tok-o">))</span> <span class="tok-o">{</span>
    <span class="tok-n">urls</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">.</span><span class="tok-na">getBytes</span><span class="tok-o">());</span>
  <span class="tok-o">}</span>
  <span class="tok-n">reader</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
<span class="tok-o">}</span>

<span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">map</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span> <span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">Any</span> <span class="tok-n">value</span><span class="tok-o">,</span>
                   <span class="tok-n">Mapper</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">,</span> <span class="tok-n">IntWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">&gt;.</span><span class="tok-na">Context</span> <span class="tok-n">context</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-cm">/* Almost all irrelevant sessions are filtered out with this check,</span>
<span class="tok-cm">     * but small number of false positives still pass this filter. */</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">urls</span><span class="tok-o">.</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">.</span><span class="tok-na">getBytes</span><span class="tok-o">()))</span> <span class="tok-o">{</span>
      <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">IntWritable</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()),</span> <span class="tok-k">new</span> <span class="tok-n">Any</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
  <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-k">new</span> <span class="tok-n">IntWritable</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">.</span><span class="tok-na">hashCode</span><span class="tok-o">()),</span> <span class="tok-k">new</span> <span class="tok-n">Any</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">));</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">reduce</span><span class="tok-o">(</span><span class="tok-n">IntWritable</span> <span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">Any</span><span class="tok-o">&gt;</span> <span class="tok-n">values</span><span class="tok-o">,</span>
                      <span class="tok-n">Reducer</span><span class="tok-o">&lt;</span><span class="tok-n">IntWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">,</span> <span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Any</span><span class="tok-o">&gt;.</span><span class="tok-na">Context</span> <span class="tok-n">context</span><span class="tok-o">)</span> <span class="tok-o">{</span>
  <span class="tok-n">Set</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">urls</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">HashSet</span><span class="tok-o">&lt;&gt;();</span>
  <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">Session</span><span class="tok-o">&gt;</span> <span class="tok-n">sessions</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;&gt;();</span>
  <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Any</span> <span class="tok-n">value</span> <span class="tok-o">:</span> <span class="tok-n">values</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">urls</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">sessions</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">session</span><span class="tok-o">);</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
  <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">Session</span> <span class="tok-n">session</span> <span class="tok-o">:</span> <span class="tok-n">sessions</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">urls</span><span class="tok-o">.</span><span class="tok-na">contains</span><span class="tok-o">(</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-na">url</span><span class="tok-o">))</span> <span class="tok-o">{</span>
      <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-n">Any</span><span class="tok-o">(</span><span class="tok-n">session</span><span class="tok-o">));</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-o">...</span>
<span class="tok-cm">/* Add URLs file as input and additionally pass path to it to mappers */</span>
<span class="tok-n">SequenceFileInputFormat</span><span class="tok-o">.</span><span class="tok-na">addInputPath</span><span class="tok-o">(</span><span class="tok-n">job</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Path</span><span class="tok-o">(</span><span class="tok-s">&quot;/sessions&quot;</span><span class="tok-o">));</span>
<span class="tok-n">SequenceFileInputFormat</span><span class="tok-o">.</span><span class="tok-na">addInputPath</span><span class="tok-o">(</span><span class="tok-n">job</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Path</span><span class="tok-o">(</span><span class="tok-s">&quot;/urls&quot;</span><span class="tok-o">));</span>
<span class="tok-n">job</span><span class="tok-o">.</span><span class="tok-na">getConfiguration</span><span class="tok-o">().</span><span class="tok-na">set</span><span class="tok-o">(</span><span class="tok-n">CONF_URL_PATH</span><span class="tok-o">,</span> <span class="tok-s">&quot;/urls&quot;</span><span class="tok-o">);</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="select-comparison.png" alt="select comparison" width="70%">
</div>
</div>
<div class="paragraph">
<p>Above solution has all the properties we need.
It scales well for any number of input URLs and session objects.
It is efficient in terms of transferred data and, in turn, in terms of running time.
It is easily tunable: we can set Bloom filter size to any value we like.
It will affect performance through number of false positives emitted from mappers but not the correctness of the algorithm.
Selecting optimal number of Bloom filter&#8217;s hash functions is a bit trickier as it involves counting
number of URLs in advance, but in practice it can be avoided be choosing some fixed value (e.g. 50)
at the cost of slightly worse than optimal number of false positives.</p>
</div>
<div class="paragraph">
<p>As in previous article, some optimizations were omitted for the sake of clarity.
If this code was intended for production use, then I would create Bloom filter in <code>main()</code> before
the job starts and pass it to mappers in serialized form to speed them up.
It is easy to do so, because Bloom filter is essentially just an ordinary bit array with a couple of parameters.
Add counters and tests, and you&#8217;ll get a production-grade solution for the frequently recurring SELECT problem.</p>
</div>
<div class="paragraph">
<p>Different problems may require some adaptations of the above approach.
In particular, you should wisely choose data structure to filter data depending on its nature and volume:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>use sorted array if key set fits into RAM</p>
</li>
<li>
<p>use sorted array of <code>hash(key)</code> for larger key sets, but be aware that it produces false positives</p>
</li>
<li>
<p>use bloom filter for even larger key sets</p>
</li>
<li>
<p>use prefix trees (<a href="https://en.wikipedia.org/wiki/Trie">trie</a>) for string keys that have long common substrings,
such as inverted URLs (<code>com.example.shop/apparel/women/dresses/https://</code>) and semantic keys (<code>SWAP-AUD-JPY-20170218</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But the idea is always the same: you want to filter out as much irrelevant data on mappers as you can.
The less irrelevant data "leaks" to reducers, the more efficient overall job is.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sources">Sources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Full source code can be found at <a href="https://github.com/andreigudkov/articles/tree/master/ph/src/java">github</a>.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-08-23 12:12:38 UTC
</div>
</div>
</body>
</html>