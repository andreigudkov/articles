<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="author" content="Andrei Gudkov">
<title>Practical Hadoop: FAQ</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}audio,canvas,video{display:inline-block}audio:not([controls]){display:none;height:0}[hidden],template{display:none}script{display:none !important}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}a{background:transparent}a:focus{outline:thin dotted}a:active,a:hover{outline:0}h1{font-size:2em;margin:.67em 0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}mark{background:#ff0;color:#000}code,kbd,pre,samp{font-family:monospace,serif;font-size:1em}pre{white-space:pre-wrap}q{quotes:"\201C" "\201D" "\2018" "\2019"}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:0}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}button,input{line-height:normal}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}textarea{overflow:auto;vertical-align:top}table{border-collapse:collapse;border-spacing:0}*,*::before,*::after{box-sizing:border-box;margin:0}body{font-family:Helvetica,Arial,sans-serif;font-size:16px;color:#222;line-height:1.5;max-width:55em;margin:0 auto}#content,#footnotes{padding-left:.5em;padding-right:.5em}strong{font-weight:bold}em{font-style:italic}:not(pre)>code{font-family:Courier,monospace;line-height:1.0}a{color:#0061c5;text-decoration:none}a:hover{text-decoration:underline}hr{border-width:0 0 1px 0;border-style:solid;border-color:#678}ul,ol{list-style-position:outside;padding-left:0;margin-left:2em}ul li ul,ul li ol,ol li ul,ol li ol{margin-left:1.414em}ul>li{list-style-type:square;font-size:80%}ul>li>*{font-size:125%}ol>li{font-weight:bold}ol>li>*{font-weight:normal}ol.arabic{list-style-type:decimal}ol.decimal{list-style-type:decimal-leading-zero}ol.loweralpha{list-style-type:lower-alpha}ol.upperalpha{list-style-type:upper-alpha}ol.lowerroman{list-style-type:lower-roman}ol.upperroman{list-style-type:upper-roman}ol.lowergreek{list-style-type:lower-greek}.dlist dt{color:#325d72;font-weight:bold}.dlist dt:not(:first-child){margin-top:1em}.dlist dd{margin-left:2em}td.hdlist1{color:#325d72;padding-right:.5em;vertical-align:top}td.hdlist2{padding-bottom:.5em}h1{font-size:28px;font-weight:normal;letter-spacing:-1px;color:white;background-color:#325d72;text-align:center;margin:0 0 .5em 0;padding:.05em .5em}@media print{h1{color:#325d72;background-color:white;font-weight:bold}}h1::after{content:':';width:0;overflow:hidden;display:inline-block;vertical-align:middle}.author{color:#325d72}.email::before{content:"<";color:#325d72}.email::after{content:">";color:#325d72}.author+br,.email+br{display:none}#author{padding-left:.5em}#toc{margin:1em 0 2em 0;padding-left:.5em}#toctitle{font-size:19px;font-weight:bold;color:#325d72;margin:.5em 0}#toc>ul{line-height:1.4;font-size:15px;margin:0 0 0 .5em}#toc ul li{list-style-type:none}#toc li{margin:0}.big{font-size:120%}.small{font-size:75%}.underline{text-decoration:underline}.overline{text-decoration:overline}.line-through{text-decoration:line-through}.aqua{color:#00bfbf}.aqua-background{background-color:#00fafa;border-radius:2px;padding:0 3px}.black{color:"black"}.black-background{background-color:"black";border-radius:2px;padding:0 3px}.blue{color:#0000bf}.blue-background{background-color:#0000fa;border-radius:2px;padding:0 3px}.fuchsia{color:#bf00bf}.fuchsia-background{background-color:#fa00fa;border-radius:2px;padding:0 3px}.gray{color:#606060}.gray-background{background-color:#7d7d7d;border-radius:2px;padding:0 3px}.green{color:#006000}.green-background{background-color:#007d00;border-radius:2px;padding:0 3px}.lime{color:#00bf00}.lime-background{background-color:#00fa00;border-radius:2px;padding:0 3px}.maroon{color:#600000}.maroon-background{background-color:#7d0000;border-radius:2px;padding:0 3px}.navy{color:#000060}.navy-background{background-color:#00007d;border-radius:2px;padding:0 3px}.olive{color:#606000}.olive-background{background-color:#7d7d00;border-radius:2px;padding:0 3px}.purple{color:#600060}.purple-background{background-color:#7d007d;border-radius:2px;padding:0 3px}.red{color:#bf0000}.red-background{background-color:#fa0000;border-radius:2px;padding:0 3px}.silver{color:#909090}.silver-background{background-color:#bcbcbc;border-radius:2px;padding:0 3px}.teal{color:#006060}.teal-background{background-color:#007d7d;border-radius:2px;padding:0 3px}.white{color:#bfbfbf}.white-background{background-color:#fafafa;border-radius:2px;padding:0 3px}.yellow{color:#bfbf00}.yellow-background{background-color:#fafa00;border-radius:2px;padding:0 3px}table.tableblock{border:1px solid #91a7b3;margin-left:auto;margin-right:auto}table.tableblock>caption.title{text-align:left;margin-bottom:.5em}table.tableblock>colgroup>col{width:inherit !important}table.tableblock>tbody>tr>td{border-style:solid;border-color:#91a7b3;border-width:0 1px;padding:0 5px 2px 5px}table.tableblock>tbody>tr:nth-of-type(2n){background-color:#f3f5f7}p.tableblock{text-align:inherit}table.tableblock>thead>tr>td,table.tableblock>thead>tr>th,table.tableblock>tfoot>tr>td,table.tableblock>tfoot>tr>th{color:#325d72;font-weight:bold;line-height:1.35;padding:2px 5px;border:1px solid #91a7b3}table.tableblock>thead>tr>th,table.tableblock>thead>tr>td{border-bottom-width:2px}table.tableblock>tfoot>tr>th,table.tableblock>tfoot>tr>td{border-top-width:2px}th.halign-left,td.halign-left{text-align:left}th.halign-right,td.halign-right{text-align:right}th.halign-center,td.halign-center{text-align:center}th.valign-top,td.valign-top{vertical-align:top}th.valign-bottom,td.valign-bottom{vertical-align:bottom}th.valign-middle,td.valign-middle{vertical-align:middle}div.listingblock{padding:.5em;border-style:solid;border-color:#678;border-width:0 0 0 2px;background-color:#f3f5f7;overflow:auto}div.listingblock .title{text-align:right}div.listingblock pre{font-family:Menlo,Consolas,Monaco,"Lucida Console",monospace;font-size:87.5%;white-space:pre;background-color:#f3f5f7 !important;margin:0}div.listingblock td.linenos{border-right:1px solid #91a7b3;padding-right:.67em}div.listingblock table.pyhltable div.linenodiv{color:#678;text-align:right}div.listingblock table.pyhltable td.code{padding-left:.67em}div.imageblock>div.content>img{max-width:98%}.text-indent{padding-left:2em}img.inlinemath{image-rendering:optimizequality;margin-top:.5ex}h2,h3,h4{font-weight:normal;color:#325d72;margin:0}h2{font-size:27px;letter-spacing:-1px;border-bottom:1px solid #91a7b3}h3{font-size:24px;letter-spacing:-0.75px}h4{font-size:21px;letter-spacing:-0.5px}.title{color:#325d72;font-weight:bold}#footer{font-size:80%;color:white;background-color:#325d72}@media print{#footer{color:#325d72;background-color:white;font-weight:bold}}#footer-text{text-align:center;padding:.5em}#footer-badges{display:none}span.footnote{vertical-align:super;font-size:80%}#footnotes>hr{display:none}#footnotes::before{display:block;border-bottom:1px solid #678;margin:.5em 0;content:"Notes";font-size:19px;font-weight:bold;color:#325d72}#footnotes .footnote{margin-left:.5em;font-size:15px}hr:not(:first-child){margin-top:1.5em}hr:not(:last-child){margin-bottom:1.5em}.imageblock:not(:last-child),.listingblock:not(:last-child),.tableblock:not(:last-child){margin-bottom:1em}p+*{margin-top:1em}.paragraph+*{margin-top:1em}p+.ulist,p+.olist,p+.dlist,p+.hdlist,.paragraph+.ulist,.paragraph+.olist,.paragraph+.dlist,.paragraph+.hdlist,.paragraph+.listingblock{margin-top:.5em !important}li *+.ulist,li *+.olist,li *+.dlist,li *+.hdlist{margin-top:.1em !important}.title:not(:first-child){margin-top:1.5em}.content+.title{margin-top:.5em !important}.title+*{margin-top:1.5em}.title+p,.title+.paragraph,.title+.ulist,.title+.olist,.title+.dlist,.title+.hdlist{margin-top:.5em !important}.ulist:not(:last-child){margin-bottom:1em}.olist:not(:last-child){margin-bottom:1em}li:not(:first-child){margin-top:.1em}.dlist:not(:last-child){margin-bottom:1em}.dlist:not(:first-child){margin-top:1em}.sect3:not(:last-child){margin-bottom:18px}.sect3:not(:first-child){margin-top:18px}h4:not(:last-child){margin-bottom:9px}.sect2:not(:last-child){margin-bottom:22px}.sect2:not(:first-child){margin-top:22px}h3:not(:last-child){margin-bottom:11px}.sect1:not(:last-child){margin-bottom:40px}.sect1:not(:first-child){margin-top:40px}#preamble:not(:last-child){margin-bottom:40px}h2:not(:last-child){margin-bottom:13px}#header:not(:last-child),#content:not(:last-child),#footnotes:not(:last-child){margin-bottom:2em}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}
</style>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments, .listingblock .pygments code { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>Practical Hadoop: FAQ</h1>
<div class="details">
<span id="author" class="author">Andrei Gudkov</span><br>
<span id="email" class="email"><a href="mailto:gudokk@gmail.com">gudokk@gmail.com</a></span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel3">
<li><a href="#_is_it_ok_to_set_mapreduce_mapreduce_failures_maxpercent_0">Is it OK to set <code>mapreduce.{map|reduce}.failures.maxpercent</code> &gt; 0?</a></li>
<li><a href="#_hadoop_kills_my_job_because_of_timeout_in_custom_output_format">Hadoop kills my job because of timeout in custom output format</a></li>
<li><a href="#_one_of_task_attempts_is_hung">One of task attempts is hung</a></li>
<li><a href="#_i_am_tired_of_implementing_writable_interface">I am tired of implementing <code>Writable</code> interface</a></li>
<li><a href="#_my_mr_job_uses_only_single_mapper_for_every_input_file">My MR job uses only single mapper for every input file</a></li>
<li><a href="#_where_can_i_find_all_configuration_options">Where can I find all configuration options?</a></li>
<li><a href="#_what_compression_settings_to_use">What compression settings to use?</a></li>
<li><a href="#_idling_reducers_prevent_other_jobs_from_running">Idling reducers prevent other jobs from running</a></li>
<li><a href="#_how_do_i_pass_data_from_job_driver_to_the_tasks">How do I pass data from job driver to the tasks?</a></li>
<li><a href="#_how_do_i_correctly_configure_dns">How do I correctly configure DNS?</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect3">
<h4 id="_is_it_ok_to_set_mapreduce_mapreduce_failures_maxpercent_0">Is it OK to set <code>mapreduce.{map|reduce}.failures.maxpercent</code> &gt; 0?</h4>
<div class="paragraph">
<p>Above pair of options (which were previously named <code>mapred.{min|max}.{map|reduce}.failures.percent</code>)
allow some tasks to fail without aborting the whole job.
Normally, if at least one task fails (because all of its attempts failed) then the whole
job is terminated immediately.
But when the above options are set to values higher than zero, the job is allowed
to succeed even when some percentage of the tasks fails, meaning that
some portion of input data may be skipped.
Most of the time this is unacceptable, but there are also cases when it is
helpful, typically in dirty data mining.</p>
</div>
<div class="paragraph">
<p>For example, consider the task of parsing and analyzing billions of binary files
crawled from the web by using random walk, like images or Excel spreadsheets.
Web is really dirty.
There are high chances that input data contains some malicious files
which will cause parser to fail with segfault or with out of memory error.
What are we going to do in this case?
Isolating malicious file, debugging and fixing the parser would be complete waste of time.
And if we manage to do so, there is no guarantee that the parser wouldn&#8217;t fail again
in another place when parsing another malicious file.
We need more robust solution.
This is when <code>failures.maxpercent</code> becomes handy.
We can solve our problem much easier just by adding single line to our job configuration:
<code>job.setInt("mapreduce.map.failures.maxpercent", 2);</code>.
Now the job will succeed even if up to 2% of tasks fail (which can be translated to 2% of input data).</p>
</div>
<div class="paragraph">
<p>One non-obvious downside of <code>failures.maxpercent</code> is that it may break further steps in
data pipeline due to idempotency violation.
You would normally expect that if you run the same job twice with the same input data,
then it will produce identical outputs.
However, in case when <code>failures.maxpercent</code> is higher than zero, this is not true.
Multiple runs with the same input data may produce different results.
This may create hard-to-debug issues.
How about a job that deletes records in a database except the "best ones"?
Consider the following workflow.
First we make a dump of the database into HDFS.
Then we run a job that reads this dump and decides for every group of records,
which one record must be retained and which ones must be deleted from the database.
Now, for some reason, we run the job twice, and we do so with <code>failures.maxpercent</code> enabled.
If some tasks fail, it will have the effect as if two job instances observed slightly different input.
One possible scenario is that first job observes and processes only records (A, B, C, D) and decides to retain B.
Second job processes only records (A, B, C, E) and decides to retain E.
Combined, these two jobs delete all five records from the database, hence breaking the very purpose of database cleanup.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hadoop_kills_my_job_because_of_timeout_in_custom_output_format">Hadoop kills my job because of timeout in custom output format</h4>
<div class="paragraph">
<p>It is common problem that you want to save data in some special format,
and this format is not of "streaming" type, i.e. it accumulates all key/values
of a single reducer in memory, then performs some complex aggregate analysis on it,
and only then dumps the data.
It is also quite common that it is performed by some third party library,
possibly written in C or C&plus;&plus;, maybe even proprietary,
which has absolutely no knowledge of and no reference to Hadoop.
For example, consider some library that takes long list of string values,
then builds optimal compression dictionary of it (at least O(n^2) time),
and only then dumps string values in compressed format.
Building compression dictionary is the troublesome step because it will
block the execution of the task attempt for quite long time.
Provided that the amount of input data is huge, it will take more time
than <code>mapreduce.task.timeout</code>, after which Hadoop framework will kill the attempt
because no <code>progress()</code> was made in that amount of time.</p>
</div>
<div class="paragraph">
<p>The straightforward solution would be just to increase <code>mapreduce.task.timeout</code>
to a higher value or to disable timeout altogether by setting option value to 0.
However, such approach is not very robust:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You may not know in advance the upper boundary of time it takes to perform non-progressable operation.
And if you do, it would be only a rough guess because actual timing depends
on the resource usage by adjacent tasks, which is unpredictable.</p>
</li>
<li>
<p>It affects other steps of MR job, including IO, <code>map()</code> and <code>reduce()</code> functions and so on.
Thus, Hadoop framework won&#8217;t be able to kill an attempt if it truly hangs.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The better solution is to spawn heartbeat thread that would call <code>progress()</code>
every couple of seconds while non-progressable operation is running.
Heartbeat thread should be started immediately before entering non-progressable section
and stopped immediately after exiting it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90</div></td><td class="code"><span></span><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">AutoProgress</span> <span class="tok-o">{</span>
  <span class="tok-kd">private</span> <span class="tok-n">Thread</span> <span class="tok-n">t</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-n">Object</span> <span class="tok-n">o</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Object</span><span class="tok-o">();</span>
  <span class="tok-kd">private</span> <span class="tok-kt">boolean</span> <span class="tok-n">isStopping</span> <span class="tok-o">=</span> <span class="tok-kc">false</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-n">TaskAttemptContext</span> <span class="tok-n">ctx</span><span class="tok-o">;</span>

  <span class="tok-kd">public</span> <span class="tok-nf">AutoProgress</span><span class="tok-o">(</span><span class="tok-n">TaskAttemptContext</span> <span class="tok-n">ctx</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-k">this</span><span class="tok-o">.</span><span class="tok-na">ctx</span> <span class="tok-o">=</span> <span class="tok-n">ctx</span><span class="tok-o">;</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">start</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Thread</span><span class="tok-o">()</span> <span class="tok-o">{</span>
      <span class="tok-nd">@Override</span>
      <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">run</span><span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">)</span> <span class="tok-o">{</span>
          <span class="tok-kd">synchronized</span> <span class="tok-o">(</span><span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">isStopping</span><span class="tok-o">)</span> <span class="tok-o">{</span>
              <span class="tok-k">return</span><span class="tok-o">;</span>
            <span class="tok-o">}</span>
            <span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">progress</span><span class="tok-o">();</span>
            <span class="tok-k">try</span> <span class="tok-o">{</span>
              <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">wait</span><span class="tok-o">(</span><span class="tok-mi">1000</span><span class="tok-o">);</span>
            <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">InterruptedException</span> <span class="tok-n">exc</span><span class="tok-o">)</span> <span class="tok-o">{</span>
              <span class="tok-k">return</span><span class="tok-o">;</span>
            <span class="tok-o">}</span>
          <span class="tok-o">}</span>
        <span class="tok-o">}</span>
      <span class="tok-o">}</span>
    <span class="tok-o">};</span>
    <span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">setName</span><span class="tok-o">(</span><span class="tok-s">&quot;AutoProgress&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">setDaemon</span><span class="tok-o">(</span><span class="tok-kc">true</span><span class="tok-o">);</span>
    <span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">();</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">stop</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-kd">synchronized</span> <span class="tok-o">(</span><span class="tok-n">o</span><span class="tok-o">)</span> <span class="tok-o">{</span>
      <span class="tok-n">isStopping</span> <span class="tok-o">=</span> <span class="tok-kc">true</span><span class="tok-o">;</span>
      <span class="tok-n">o</span><span class="tok-o">.</span><span class="tok-na">notify</span><span class="tok-o">();</span>
    <span class="tok-o">}</span>
    <span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-na">isAlive</span><span class="tok-o">());</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-c1">// custom format</span>
<span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kd">class</span> <span class="tok-nc">DictionaryCompressedOutputFormat</span> <span class="tok-kd">extends</span> <span class="tok-n">FileOutputFormat</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Text</span><span class="tok-o">&gt;</span> <span class="tok-o">{</span>
  <span class="tok-kd">public</span> <span class="tok-nf">DictionaryCompressedOutputFormat</span><span class="tok-o">()</span> <span class="tok-o">{</span>
    <span class="tok-kd">super</span><span class="tok-o">();</span>
  <span class="tok-o">}</span>

  <span class="tok-nd">@Override</span>
  <span class="tok-kd">public</span> <span class="tok-n">RecordWriter</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Text</span><span class="tok-o">&gt;</span> <span class="tok-nf">getRecordWriter</span><span class="tok-o">(</span><span class="tok-n">TaskAttemptContext</span> <span class="tok-n">ctx</span><span class="tok-o">)</span>
      <span class="tok-kd">throws</span> <span class="tok-n">IOException</span><span class="tok-o">,</span> <span class="tok-n">InterruptedException</span> <span class="tok-o">{</span>

    <span class="tok-n">Configuration</span> <span class="tok-n">conf</span> <span class="tok-o">=</span> <span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-na">getConfiguration</span><span class="tok-o">();</span>
    <span class="tok-n">Path</span> <span class="tok-n">path</span> <span class="tok-o">=</span> <span class="tok-n">getDefaultWorkFile</span><span class="tok-o">(</span><span class="tok-n">ctx</span><span class="tok-o">,</span> <span class="tok-s">&quot;.bin&quot;</span><span class="tok-o">);</span>
    <span class="tok-n">FileSystem</span> <span class="tok-n">fs</span> <span class="tok-o">=</span> <span class="tok-n">path</span><span class="tok-o">.</span><span class="tok-na">getFileSystem</span><span class="tok-o">(</span><span class="tok-n">conf</span><span class="tok-o">);</span>
    <span class="tok-kd">final</span> <span class="tok-n">FSDataOutputStream</span> <span class="tok-n">stream</span> <span class="tok-o">=</span> <span class="tok-n">fs</span><span class="tok-o">.</span><span class="tok-na">create</span><span class="tok-o">(</span><span class="tok-n">path</span><span class="tok-o">,</span> <span class="tok-kc">false</span><span class="tok-o">);</span>

    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-n">RecordWriter</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">Text</span><span class="tok-o">&gt;()</span> <span class="tok-o">{</span>
      <span class="tok-kd">private</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">values</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;();</span>

      <span class="tok-nd">@Override</span>
      <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">write</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span> <span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">Text</span> <span class="tok-n">value</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">IOException</span><span class="tok-o">,</span> <span class="tok-n">InterruptedException</span> <span class="tok-o">{</span>
        <span class="tok-n">values</span><span class="tok-o">.</span><span class="tok-na">add</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">toString</span><span class="tok-o">());</span>
      <span class="tok-o">}</span>

      <span class="tok-nd">@Override</span>
      <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">close</span><span class="tok-o">(</span><span class="tok-n">TaskAttemptContext</span> <span class="tok-n">ctx</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">IOException</span><span class="tok-o">,</span> <span class="tok-n">InterruptedException</span> <span class="tok-o">{</span>
        <span class="tok-n">AutoProgress</span> <span class="tok-n">p</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">AutoProgress</span><span class="tok-o">(</span><span class="tok-n">ctx</span><span class="tok-o">);</span>
        <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">start</span><span class="tok-o">();</span>

        <span class="tok-n">Dictionary</span> <span class="tok-n">dict</span> <span class="tok-o">=</span> <span class="tok-kc">null</span><span class="tok-o">;</span>
        <span class="tok-k">try</span> <span class="tok-o">{</span>
          <span class="tok-n">dict</span> <span class="tok-o">=</span> <span class="tok-n">Dictionary</span><span class="tok-o">.</span><span class="tok-na">buildOptimalDictionary</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">);</span>
        <span class="tok-o">}</span> <span class="tok-k">finally</span> <span class="tok-o">{</span>
          <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-na">stop</span><span class="tok-o">();</span>
        <span class="tok-o">}</span>

        <span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">writeInt</span><span class="tok-o">(</span><span class="tok-n">values</span><span class="tok-o">.</span><span class="tok-na">size</span><span class="tok-o">());</span>
        <span class="tok-k">for</span> <span class="tok-o">(</span><span class="tok-n">String</span> <span class="tok-n">value</span> <span class="tok-o">:</span> <span class="tok-n">values</span><span class="tok-o">)</span> <span class="tok-o">{</span>
          <span class="tok-kt">byte</span><span class="tok-o">[]</span> <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">dict</span><span class="tok-o">.</span><span class="tok-na">encode</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">);</span>
          <span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">writeInt</span><span class="tok-o">(</span><span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">);</span>
          <span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">data</span><span class="tok-o">);</span>
        <span class="tok-o">}</span>

        <span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
      <span class="tok-o">}</span>
    <span class="tok-o">};</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_one_of_task_attempts_is_hung">One of task attempts is hung</h4>
<div class="paragraph">
<p>Debugging bigdata applications is tedious job.
No matter how hard you test your application, there is always a chance that it will work incorrectly
on production data.
This is simply because tests are performed on some very limited dataset compared to production volumes.</p>
</div>
<div class="paragraph">
<p>If some task attempt is hung, usually the fastest way you can learn more about it is to find out its stack trace.
In all versions of Hadoop you can do this the hard way:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate task attempt in the web UI.
You will need to traverse along a long list of links, something like this:
YARN resource manager UI
  &#8594; application_xxxxxx
  &#8594; appattempt_xxxxxx
  &#8594; Tracking URL: Appliation Master
  &#8594; job_xxxxxx
  &#8594; Reduce running tasks (1)
  &#8594; task_xxxxxx</p>
</li>
<li>
<p>Log in to the server where task attempt is running: <code>ssh &lt;Node&gt;</code></p>
</li>
<li>
<p>Find out PID of the process with <code>ps aux | grep &lt;Attempt&gt;</code></p>
</li>
<li>
<p>Send SIGQUIT to it: <code>kill -3 &lt;pid&gt;</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>JVM installs signal handler for SIGQUIT that dumps stacktraces of all threads to stdout.
You can capture the output from web UI (&#8594; logs &#8594; stdout) or directly from task attempt
local log file in the server where you logged in.
Stack trace should give you enough information about where you should focus on finding the bug.</p>
</div>
</div>
<div class="sect3">
<h4 id="_i_am_tired_of_implementing_writable_interface">I am tired of implementing <code>Writable</code> interface</h4>
<div class="paragraph">
<p>Manual implementation of <code>Writable</code> interface makes sense only for very small classes
and typically only for keys (to speed up comparison).
For larger classes it is cheaper to use codegenerating with serialization, like protobuf or thrift
along with Twitter&#8217;s <a href="https://github.com/twitter/elephant-bird/">elephant-bird</a> wrapper.</p>
</div>
<div class="paragraph">
<p>More than that, I advise to encapsulate all classes used in the whole data pipeline into single
outer class (I call it <code>Any</code> in the example below).
Rationale is to reduce number of entities and, in turn, number of errors
related to incorrect specification of <code>setOutputKeyClass()</code>, <code>setMapOutputKeyClass()</code> and so on.
If single outer class is used, then you can always store data in sequence files in format
(<code>NullWritable</code>, <code>ProtobufWritable&lt;Any&gt;</code>).
If you add more jobs to your dataflow, you just need to add additional fields into <code>Any</code> class.
Without <code>Any</code>, you probably would need to create at least two separate message classes for every job:
one is to act as map output value class, and another one is for job output value class.</p>
</div>
<div class="paragraph">
<p>Below is the skeleton for a job that takes an HTML page
and tries to parse it as an article into title, keywords and so on.
First of all we create a protobuf message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="proto"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</div></td><td class="code"><span></span><span class="tok-kd">message</span> <span class="tok-nc">Keyword</span> <span class="tok-p">{</span>
  <span class="tok-k">required</span> <span class="tok-kt">string</span> <span class="tok-na">keyword</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
  <span class="tok-k">required</span> <span class="tok-kt">double</span> <span class="tok-na">weight</span> <span class="tok-o">=</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">message</span> <span class="tok-nc">Point</span> <span class="tok-p">{</span>
  <span class="tok-k">required</span> <span class="tok-kt">double</span> <span class="tok-na">lat</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
  <span class="tok-k">required</span> <span class="tok-kt">double</span> <span class="tok-na">lon</span> <span class="tok-o">=</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">message</span> <span class="tok-nc">Location</span> <span class="tok-p">{</span>
  <span class="tok-k">required</span> <span class="tok-kt">string</span> <span class="tok-na">name</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
  <span class="tok-k">repeated</span> <span class="tok-n">Point</span> <span class="tok-na">polygon</span> <span class="tok-o">=</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">message</span> <span class="tok-nc">Any</span> <span class="tok-p">{</span>
  <span class="tok-k">optional</span> <span class="tok-kt">string</span> <span class="tok-na">url</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
  <span class="tok-k">optional</span> <span class="tok-kt">string</span> <span class="tok-na">html</span> <span class="tok-o">=</span> <span class="tok-mi">2</span><span class="tok-p">;</span>

  <span class="tok-k">optional</span> <span class="tok-kt">string</span> <span class="tok-na">title</span> <span class="tok-o">=</span> <span class="tok-mi">3</span><span class="tok-p">;</span>
  <span class="tok-k">repeated</span> <span class="tok-n">Keyword</span> <span class="tok-na">keywords</span> <span class="tok-o">=</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
  <span class="tok-k">optional</span> <span class="tok-n">Location</span> <span class="tok-na">location</span> <span class="tok-o">=</span> <span class="tok-mi">5</span><span class="tok-p">;</span>
  <span class="tok-k">optional</span> <span class="tok-kt">bytes</span> <span class="tok-na">image</span> <span class="tok-o">=</span> <span class="tok-mi">6</span><span class="tok-p">;</span>

  <span class="tok-c1">// next ID to use: 7</span>
  <span class="tok-c1">// this message can be really huge</span>
<span class="tok-p">}</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Input collection is stored as sequence file of <code>NullWritable</code> as key and <code>Any{url, html}</code> as a value,
meaning that only two fields are set.
Output of the job is stored as sequence file of <code>NullWritable</code> and <code>Any{url, title, keywords, location, image}</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</div></td><td class="code"><span></span><span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kd">class</span> <span class="tok-nc">MapperImpl</span> <span class="tok-kd">extends</span> <span class="tok-n">Mapper</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">ProtobufWritable</span><span class="tok-o">&lt;</span><span class="tok-n">Any</span><span class="tok-o">&gt;,</span> <span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">ProtobufWritable</span><span class="tok-o">&lt;</span><span class="tok-n">Any</span><span class="tok-o">&gt;&gt;</span> <span class="tok-o">{</span>
  <span class="tok-nd">@Override</span>
  <span class="tok-kd">protected</span> <span class="tok-kt">void</span> <span class="tok-nf">map</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span> <span class="tok-n">key</span><span class="tok-o">,</span> <span class="tok-n">ProtobufWritable</span><span class="tok-o">&lt;</span><span class="tok-n">Any</span><span class="tok-o">&gt;</span> <span class="tok-n">value</span><span class="tok-o">,</span> <span class="tok-n">Mapper</span><span class="tok-o">&lt;</span><span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">ProtobufWritable</span><span class="tok-o">&lt;</span><span class="tok-n">Any</span><span class="tok-o">&gt;,</span> <span class="tok-n">NullWritable</span><span class="tok-o">,</span> <span class="tok-n">ProtobufWritable</span><span class="tok-o">&lt;</span><span class="tok-n">Any</span><span class="tok-o">&gt;&gt;.</span><span class="tok-na">Context</span> <span class="tok-n">context</span><span class="tok-o">)</span>
      <span class="tok-kd">throws</span> <span class="tok-n">IOException</span><span class="tok-o">,</span> <span class="tok-n">InterruptedException</span> <span class="tok-o">{</span>

    <span class="tok-n">ParseContext</span> <span class="tok-n">pc</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ParseContext</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">getHtml</span><span class="tok-o">());</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">pc</span><span class="tok-o">.</span><span class="tok-na">parses</span><span class="tok-o">())</span> <span class="tok-o">{</span>
      <span class="tok-n">Any</span> <span class="tok-n">any</span> <span class="tok-o">=</span> <span class="tok-n">Any</span><span class="tok-o">.</span><span class="tok-na">newBuilder</span><span class="tok-o">()</span>
                   <span class="tok-o">.</span><span class="tok-na">setUrl</span><span class="tok-o">(</span><span class="tok-n">value</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">().</span><span class="tok-na">getUrl</span><span class="tok-o">())</span>
                   <span class="tok-o">.</span><span class="tok-na">addAllKeywords</span><span class="tok-o">(...)</span>
                   <span class="tok-o">.</span><span class="tok-na">setLocation</span><span class="tok-o">(...)</span>
                   <span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">();</span>
      <span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-na">write</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(),</span> <span class="tok-k">new</span> <span class="tok-n">ProtobufWritable</span><span class="tok-o">&lt;</span><span class="tok-n">Any</span><span class="tok-o">&gt;(</span><span class="tok-n">any</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">TypeRef</span><span class="tok-o">&lt;</span><span class="tok-n">Any</span><span class="tok-o">&gt;(){}));</span>
    <span class="tok-o">}</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span>

<span class="tok-o">...</span>

<span class="tok-n">job</span><span class="tok-o">.</span><span class="tok-na">setOutputKeyClass</span><span class="tok-o">(</span><span class="tok-n">NullWritable</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
<span class="tok-n">job</span><span class="tok-o">.</span><span class="tok-na">setOutputValueClass</span><span class="tok-o">(</span><span class="tok-n">ProtobufWritable</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
<span class="tok-n">job</span><span class="tok-o">.</span><span class="tok-na">setOutputFormatClass</span><span class="tok-o">(</span><span class="tok-n">SequenceFileOutputFormat</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
<span class="tok-n">SequenceFileOutputFormat</span><span class="tok-o">.</span><span class="tok-na">setOutputPath</span><span class="tok-o">(</span><span class="tok-n">job</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Path</span><span class="tok-o">(</span><span class="tok-s">&quot;hdfs://...&quot;</span><span class="tok-o">));</span>
<span class="tok-n">SequenceFileOutputFormat</span><span class="tok-o">.</span><span class="tok-na">setCompressOutput</span><span class="tok-o">(</span><span class="tok-n">job</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">);</span>
<span class="tok-n">SequenceFileOutputFormat</span><span class="tok-o">.</span><span class="tok-na">setOutputCompressionType</span><span class="tok-o">(</span><span class="tok-n">job</span><span class="tok-o">,</span> <span class="tok-n">CompressionType</span><span class="tok-o">.</span><span class="tok-na">BLOCK</span><span class="tok-o">);</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_my_mr_job_uses_only_single_mapper_for_every_input_file">My MR job uses only single mapper for every input file</h4>
<div class="paragraph">
<p>Your input files are not in splittable format.
The most probable cause is that they are in ".txt.gz" format.
You would be fine if you used raw text files or if you used <code>SequenceFile</code>
(with any compression type and codec), but not gzipped text files.</p>
</div>
<div class="paragraph">
<p>When job is started, Hadoop generates a number of splits for every input file,
one split is for one mapper.
Single split is a tuple of (path, offset, length) except for some exotic input formats.
You would expect that a split is created by key/value boundary, but it is not true.
The reason is that in order for split to be created by key/value boundary,
the file must be read entirely in advance, which is unacceptable.
Instead, every file is divided into splits of exactly block size bytes,
ignoring the fact that single key/value pair may easily span two adjacent splits.
Now, when mapper starts, it opens the file, seeks offset, and then <em>synchronizes</em>
to the beginning of the next record.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">KeyValueInputStream</span> <span class="tok-n">stream</span> <span class="tok-o">=</span> <span class="tok-n">inputFormat</span><span class="tok-o">.</span><span class="tok-na">open</span><span class="tok-o">(...);</span>
<span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">seek</span><span class="tok-o">(</span><span class="tok-n">split</span><span class="tok-o">.</span><span class="tok-na">offset</span><span class="tok-o">());</span>
<span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">synchronizeUntilNextRecord</span><span class="tok-o">();</span>
<span class="tok-k">while</span> <span class="tok-o">(</span><span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">position</span><span class="tok-o">()</span> <span class="tok-o">&lt;</span> <span class="tok-n">split</span><span class="tok-o">.</span><span class="tok-na">offset</span><span class="tok-o">()</span> <span class="tok-o">+</span> <span class="tok-n">split</span><span class="tok-o">.</span><span class="tok-na">length</span><span class="tok-o">())</span> <span class="tok-o">{</span>
  <span class="tok-n">handle</span><span class="tok-o">(</span><span class="tok-n">stream</span><span class="tok-o">.</span><span class="tok-na">readRecord</span><span class="tok-o">());</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Such algorithm guarantees that every record will be processed once and only once.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="splits.svg" alt="splits" width="80%">
</div>
</div>
<div class="paragraph">
<p>Synchronization implementation depends on file format.
In plain text files, for example, every single line is a single key/value.
To synchronize to the next record from arbitrary binary position, you just need
to read bytes until '\n' is encountered.
<code>SequenceFile</code> implements synchronization by incorporating special unique binary markers between key/values.
But there is no way to synchronize to the next record in gzipped text files
without reading the file from the very beginning.
Thus, for every *.txt.gz., Hadoop creates single split (path, offset=0, length=path.size())
no matter how large the file is.</p>
</div>
</div>
<div class="sect3">
<h4 id="_where_can_i_find_all_configuration_options">Where can I find all configuration options?</h4>
<div class="paragraph">
<p>All options, their default values and descriptions reside inside <code>*-default.xml</code> files:
<code>core-default.xml</code>, <code>hdfs-default.xml</code>, <code>mapred-default.xml</code>, <code>yarn-default.xml</code>.
Hadoop web site hosts most recent version of every default configuration file rendered
into easily readable HTML table.
So, the easiest way to find full list of options is just to search for one of the above
files on the web.</p>
</div>
<div class="paragraph">
<p>Another way is to extract default configuration file directly from respective JAR file.
This will get you exactly the version used in your environment.
For example, <code>mapred-default.xml</code> file is packaged inside <code>hadoop-mapreduce-client-core</code> JAR
and can be extracted with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cd $HADOOP_HOME
$ find . -name "hadoop-mapreduce-client-core*"
./share/hadoop/mapreduce/sources/hadoop-mapreduce-client-core-2.9.2-sources.jar
./share/hadoop/mapreduce/sources/hadoop-mapreduce-client-core-2.9.2-test-sources.jar
./share/hadoop/mapreduce/hadoop-mapreduce-client-core-2.9.2.jar
$ cp hadoop-mapreduce-client-core-2.9.2.jar /tmp/
$ cd /tmp
$ jar xvf hadoop-mapreduce-client-core-2.9.2.jar
&lt;all files are extracted into current directory&gt;
$ cat mapred-default.xml</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_what_compression_settings_to_use">What compression settings to use?</h4>
<div class="paragraph">
<p>You most likely want to compress output files,
but not the intermediate files between mappers and reducers (<code>mapreduce.map.output.compress</code>).</p>
</div>
<div class="paragraph">
<p>When using compression, do not use heavy codecs like bz2.
If you&#8217;re working with Hadoop, then capacity and throughput are not the issues.
The bottleneck is CPU time it takes to compress and decompress the data.
So, stick with faster codecs like lz4, lzo or snappy.</p>
</div>
<div class="paragraph">
<p>Use block compression instead of per-record.
If records are small, then compressing every single record independently
won&#8217;t provide any reduction in size.
There is not way codec is able to build sufficiently large dictionary over such small piece of data.
But it will anyway consume CPU cycles.
Record compression makes sense only when records are large enough and <code>SequenceFile</code> is used
as random-access key-value storage, like in <code>MapFile</code>.
In other cases block compression is better because it compresses every decently-sized group of records,
thus giving codec more opportunity to build high-quality dictionary.</p>
</div>
<div class="paragraph">
<p>Finally, watch out for warnings about inability to load native libraries.
You definitely want to use fast native libraries for compression and not slow pure java implementations.</p>
</div>
<div class="paragraph">
<p>Assuming that output format is <code>SequenceFile</code>, the following piece of code
demonstrates sane compression settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5</div></td><td class="code"><span></span><span class="tok-n">job</span><span class="tok-o">.</span><span class="tok-na">setOutputFormatClass</span><span class="tok-o">(</span><span class="tok-n">SequenceFileOutputFormat</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
<span class="tok-n">SequenceFileOutputFormat</span><span class="tok-o">.</span><span class="tok-na">setOutputPath</span><span class="tok-o">(</span><span class="tok-n">job</span><span class="tok-o">,</span> <span class="tok-k">new</span> <span class="tok-n">Path</span><span class="tok-o">(</span><span class="tok-s">&quot;hdfs://.../output_dir&quot;</span><span class="tok-o">));</span>
<span class="tok-n">SequenceFileOutputFormat</span><span class="tok-o">.</span><span class="tok-na">setCompressOutput</span><span class="tok-o">(</span><span class="tok-n">job</span><span class="tok-o">,</span> <span class="tok-kc">true</span><span class="tok-o">);</span>
<span class="tok-n">SequenceFileOutputFormat</span><span class="tok-o">.</span><span class="tok-na">setOutputCompressionType</span><span class="tok-o">(</span><span class="tok-n">job</span><span class="tok-o">,</span> <span class="tok-n">CompressionType</span><span class="tok-o">.</span><span class="tok-na">BLOCK</span><span class="tok-o">);</span>
<span class="tok-n">SequenceFileOutputFormat</span><span class="tok-o">.</span><span class="tok-na">setOutputCompressorClass</span><span class="tok-o">(</span><span class="tok-n">job</span><span class="tok-o">,</span> <span class="tok-n">Lz4Codec</span><span class="tok-o">.</span><span class="tok-na">class</span><span class="tok-o">);</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_idling_reducers_prevent_other_jobs_from_running">Idling reducers prevent other jobs from running</h4>
<div class="paragraph">
<p>The most probable cause is that you use default value for option
<code>mapreduce.job.reduce.slowstart.completedmaps</code>, which is 0.05.
While the number of completed map tasks is less than 5%, no reducers are started.
But as soon as 5% mappers are finished, reducers are launched.
There is not limit on the number of started reducers.
If cluster resources are ample at this moment, then they all will start.</p>
</div>
<div class="paragraph">
<p>The term "to start" is an overstatement.
Because only 5% of the mappers are finished, reducers won&#8217;t be able to do anything
useful apart from occasionally fetching data from recently completed mappers.
All other time they will be simply idling.
But they still occupy cluster resources, leading to resource underutilization and
preventing other jobs from being executed.</p>
</div>
<div class="paragraph">
<p>In order to prevent reducers from idling,
increase the aforementioned option to much higher value, 0.8 or even 0.95.
Reducers will start only after 80% (95%) of mappers are finished,
and they will have immediately a lot of work to do.
Alternatively, you can put a limit on a number of simultaneously running reducers per job with the option
<code>mapreduce.job.running.reduce.limit</code>, or to tune the scheduler.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_do_i_pass_data_from_job_driver_to_the_tasks">How do I pass data from job driver to the tasks?</h4>
<div class="paragraph">
<p>It is quite common that you need to pass some data, such as runtime parameters,
from job driver to mappers and reducers.
There are a lot of ways to achieve this depending on data size.
If the data is just a couple of primitive values, you can put them directly into job&#8217;s <code>Configuration</code>
one by one by unique names and retrieve later in <code>Mapper.setup()</code> and <code>Reducer.setup()</code> methods.</p>
</div>
<div class="paragraph">
<p>For more complex data you can create separate class, serialize it into base64
and pass to <code>Configuration</code> as a single option, as demonstrated below.
Obviously, this approach should be used only if data size is relatively small,
up to 100 kilobytes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</div></td><td class="code"><span></span><span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kd">class</span> <span class="tok-nc">Coeffs</span> <span class="tok-kd">implements</span> <span class="tok-n">Serializable</span> <span class="tok-o">{</span>
  <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-kt">long</span> <span class="tok-n">serialVersionUID</span> <span class="tok-o">=</span> <span class="tok-mi">1L</span><span class="tok-o">;</span>
  <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">CONF_NAME</span> <span class="tok-o">=</span> <span class="tok-s">&quot;job.coeffs&quot;</span><span class="tok-o">;</span>

  <span class="tok-kd">public</span> <span class="tok-kt">double</span><span class="tok-o">[][]</span> <span class="tok-n">transform_mat</span><span class="tok-o">;</span>
  <span class="tok-kd">public</span> <span class="tok-kt">double</span> <span class="tok-n">threshold_x</span><span class="tok-o">;</span>
  <span class="tok-kd">public</span> <span class="tok-kt">double</span> <span class="tok-n">threshold_y</span><span class="tok-o">;</span>
  <span class="tok-kd">public</span> <span class="tok-kt">double</span> <span class="tok-n">threshold_z</span><span class="tok-o">;</span>

  <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kt">void</span> <span class="tok-nf">store</span><span class="tok-o">(</span><span class="tok-n">Configuration</span> <span class="tok-n">conf</span><span class="tok-o">,</span> <span class="tok-n">Coeffs</span> <span class="tok-n">data</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">IOException</span> <span class="tok-o">{</span>
    <span class="tok-n">ByteArrayOutputStream</span> <span class="tok-n">baos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ByteArrayOutputStream</span><span class="tok-o">();</span>
    <span class="tok-n">ObjectOutputStream</span> <span class="tok-n">oos</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ObjectOutputStream</span><span class="tok-o">(</span><span class="tok-n">baos</span><span class="tok-o">);</span>
    <span class="tok-n">oos</span><span class="tok-o">.</span><span class="tok-na">writeObject</span><span class="tok-o">(</span><span class="tok-n">data</span><span class="tok-o">);</span>
    <span class="tok-n">oos</span><span class="tok-o">.</span><span class="tok-na">close</span><span class="tok-o">();</span>
    <span class="tok-n">String</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-n">Base64</span><span class="tok-o">.</span><span class="tok-na">getEncoder</span><span class="tok-o">().</span><span class="tok-na">encodeToString</span><span class="tok-o">(</span><span class="tok-n">baos</span><span class="tok-o">.</span><span class="tok-na">toByteArray</span><span class="tok-o">());</span>
    <span class="tok-n">conf</span><span class="tok-o">.</span><span class="tok-na">set</span><span class="tok-o">(</span><span class="tok-n">CONF_NAME</span><span class="tok-o">,</span> <span class="tok-n">x</span><span class="tok-o">);</span>
  <span class="tok-o">}</span>

  <span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-n">Coeffs</span> <span class="tok-nf">load</span><span class="tok-o">(</span><span class="tok-n">Configuration</span> <span class="tok-n">conf</span><span class="tok-o">)</span> <span class="tok-kd">throws</span> <span class="tok-n">IOException</span><span class="tok-o">,</span> <span class="tok-n">ClassNotFoundException</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-n">conf</span><span class="tok-o">.</span><span class="tok-na">get</span><span class="tok-o">(</span><span class="tok-n">CONF_NAME</span><span class="tok-o">);</span>
    <span class="tok-n">ByteArrayInputStream</span> <span class="tok-n">bais</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ByteArrayInputStream</span><span class="tok-o">(</span><span class="tok-n">Base64</span><span class="tok-o">.</span><span class="tok-na">getDecoder</span><span class="tok-o">().</span><span class="tok-na">decode</span><span class="tok-o">(</span><span class="tok-n">x</span><span class="tok-o">));</span>
    <span class="tok-n">ObjectInputStream</span> <span class="tok-n">ois</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ObjectInputStream</span><span class="tok-o">(</span><span class="tok-n">bais</span><span class="tok-o">);</span>
    <span class="tok-k">return</span> <span class="tok-o">(</span><span class="tok-n">Coeffs</span><span class="tok-o">)</span><span class="tok-n">ois</span><span class="tok-o">.</span><span class="tok-na">readObject</span><span class="tok-o">();</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>For even larger data sizes, MapReduce framework provides <code>DistributedCache</code>.
See its API reference for detailed instructions.
Data that you pass via distributed cache is copied onto local filesystem of every node.
The benefit of using distributed cache is that only single copy of data per node is made,
no matter how many job tasks are running on the node.</p>
</div>
<div class="paragraph">
<p>Finally, you can always use HDFS directly.
Put your data into HDFS and set some option in your job configuration to let
mappers and reducers know where to look for the data.
Next you can use this data in any way you wish.
But bear in mind that order in which mappers and reducers are launched is unpredictable,
and that tasks can fail and can also be executed speculatively (multiple identical tasks
running at the same time, as soon as one of the tasks completes successfully, other tasks
become unnecessary and are killed).
To be independent from the task execution order, you should keep data in HDFS read-only.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_do_i_correctly_configure_dns">How do I correctly configure DNS?</h4>
<div class="paragraph">
<p>Arguably, DNS is the most troublesome piece of setup for any distributed system,
not only Hadoop.
To ensure smooth operation, you should do all of the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Select unique hostname for every cluster node, e.g. "node1", "node2", and so on.</p>
</li>
<li>
<p>Ensure that every node "knows" its own hostname correctly.
Command <code>hostname</code> must returned the hostname you selected and not something else.
To change hostname, you typically (depends on Linux distribution) need to
edit <code>/etc/hostname</code> and reboot the machine.</p>
</li>
<li>
<p>Ensure that your DNS server is configured properly for forward lookup.
This means that no matter which node your are currently logged in to,
the command <code>nslookup &lt;nodename&gt;</code> returns the primary IP address of the respective node
for every node in the cluster.</p>
</li>
<li>
<p>Ensure that DNS server is configured properly for reverse lookup.
No matter which node you are currently logged in to,
the command <code>nslookup &lt;primary_ip_address&gt;</code> must return selected hostname.</p>
</li>
<li>
<p>Use selected hostnames in all Hadoop configuration files (<code>/etc/hadoop/slaves</code>,
<code>hdfs-site.xml</code>, etc) and in paths (<code>hdfs://node1:9000/a/b/c</code>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You should ideally avoid aliases.
This doesn&#8217;t mean that cluster won&#8217;t work with aliases, but avoiding aliases will make setup easier.</p>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-01-22 09:38:50 UTC
</div>
</div>
</body>
</html>